import { __awaiter, __generator } from "tslib";
import { JSDOM } from 'jsdom';
import { Analytics } from '../analytics';
// @ts-ignore loadLegacySettings mocked dependency is accused as unused
import { AnalyticsBrowser } from '../browser';
import { TEST_WRITEKEY } from './test-writekeys';
var writeKey = TEST_WRITEKEY;
describe('queryString', function () {
    var jsd;
    beforeEach(function () { return __awaiter(void 0, void 0, void 0, function () {
        var html, windowSpy;
        return __generator(this, function (_a) {
            jest.restoreAllMocks();
            jest.resetAllMocks();
            html = "\n    <!DOCTYPE html>\n      <head>\n        <script>'hi'</script>\n      </head>\n      <body>\n      </body>\n    </html>\n    ".trim();
            jsd = new JSDOM(html, {
                runScripts: 'dangerously',
                resources: 'usable',
                url: 'https://localhost',
            });
            windowSpy = jest.spyOn(global, 'window', 'get');
            windowSpy.mockImplementation(function () { return jsd.window; });
            return [2 /*return*/];
        });
    }); });
    it('applies query string logic if window.location.search is present', function () { return __awaiter(void 0, void 0, void 0, function () {
        var mockQueryString;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    jest.mock('../analytics');
                    mockQueryString = jest
                        .fn()
                        .mockImplementation(function () { return Promise.resolve(); });
                    Analytics.prototype.queryString = mockQueryString;
                    jsd.reconfigure({
                        url: 'https://localhost/?ajs_id=123',
                    });
                    return [4 /*yield*/, AnalyticsBrowser.load({ writeKey: writeKey })];
                case 1:
                    _a.sent();
                    expect(mockQueryString).toHaveBeenCalledWith('?ajs_id=123');
                    return [2 /*return*/];
            }
        });
    }); });
    it('applies query string logic if window.location.hash is present', function () { return __awaiter(void 0, void 0, void 0, function () {
        var mockQueryString;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    jest.mock('../analytics');
                    mockQueryString = jest
                        .fn()
                        .mockImplementation(function () { return Promise.resolve(); });
                    Analytics.prototype.queryString = mockQueryString;
                    jsd.reconfigure({
                        url: 'https://localhost/#/?ajs_id=123',
                    });
                    return [4 /*yield*/, AnalyticsBrowser.load({ writeKey: writeKey })];
                case 1:
                    _a.sent();
                    expect(mockQueryString).toHaveBeenCalledWith('?ajs_id=123');
                    jsd.reconfigure({
                        url: 'https://localhost/#about?ajs_id=123',
                    });
                    return [4 /*yield*/, AnalyticsBrowser.load({ writeKey: writeKey })];
                case 2:
                    _a.sent();
                    expect(mockQueryString).toHaveBeenCalledWith('?ajs_id=123');
                    return [2 /*return*/];
            }
        });
    }); });
    it('applies query string logic if window.location.hash is present in different formats', function () { return __awaiter(void 0, void 0, void 0, function () {
        var mockQueryString;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    jest.mock('../analytics');
                    mockQueryString = jest
                        .fn()
                        .mockImplementation(function () { return Promise.resolve(); });
                    Analytics.prototype.queryString = mockQueryString;
                    jsd.reconfigure({
                        url: 'https://localhost/#about?ajs_id=123',
                    });
                    return [4 /*yield*/, AnalyticsBrowser.load({ writeKey: writeKey })];
                case 1:
                    _a.sent();
                    expect(mockQueryString).toHaveBeenCalledWith('?ajs_id=123');
                    return [2 /*return*/];
            }
        });
    }); });
});
//# sourceMappingURL=query-string.integration.test.js.map